# NMap

ハンズオン: 
https://tryhackme.com/room/furthernmap

---

## ポートとは?
- ポートはよくドアに例えられる。
  - IPアドレスが住所 - 家であれば、ポートは外に出る・外から入るドアに該当します。

- 全てのコンピュータには合計65535個のポートがある。
- ただし一部は標準ポートとして予約されている。
  - HTTP: 80
  - HTTPS: 443
  - SSH: 22

> これらのポートは，ホストとしてサービスを実行している側(つまりサーバー)が開くものである。
>
> こちら(クライアント側)がアクセスする際には適当なポート番号(10000番台)が使われる。
>
> 例: サイトにアクセスする際，サイトのサーバーの80ポートと自分のPCの18753ポートが接続される。

- **NMap**は，特定のサーバーをスキャンし，どのポートがどのように使用されているかを調べるコマンドである。

## NMap の主要なスイッチ


---

- -vv: より詳細な情報を表示させる
- -O: ターゲットで実行されているOSを調べる
- -sV: ターゲットで実行されているサービスのバージョンを調べる

> -A(Aggressice) オプション1つで-O, -sVどちらも有効にできる!!

- -T1 ~ -T5: スキャンの速度を上げる。早いほど結果は雑になる
- -p: スキャンするポートを選択。
  - -p 80 で80ポート
  - -p 1000-1500 で1000-1500ポートをスキャン
  - -p- で全ポートをスキャン
 - -oN \<FILE NAME>: ファイルに出力結果を保存。
- --script \<script name>: 指定したスクリプトを使って，nmapを拡張できる。 


## スキャンの種類

- SYN "Half-open" Scans (-sS)
  - もっとも一般的かつ有用なオプション。
  - TCPの3way ハンドシェイクにおけるSYNパケットの送信のみを行い，応答の有(SYN/ACK返信)/無(RST返信)を見てポートを分類する。*
    - そのため秘匿性が高い
  - 欠点: SYNスキャンでは生パケットを作成する機能が必要であり，これにはSudo権限が必要。
  
- TCP Connect Scans (-sT)
  - -Ssが使えない時の代替手段。OSのシステムコール( connect() )を使い，3way ハンドシェイクにしたがって丁寧に(?)ポートをスキャンする。
  - 相違点:
    - ACKを最後に送って確認応答する
    - RSTが帰ってくるとNmapはポートが閉じられたことを確認
    - ファイアウォールにドロップされると，ポートがフィルタリングされていると確認

- UDP Scans (-sU)
  - UDP通信はコネクションレスであり，一方的な通信を行う。この特性のせいでUDP通信をスキャンするのはかなり困難で低速。
  - UDPスキャンは、空の(データなし)UDPヘッダを各ターゲットポートに送ることで機能する。
    - ICMPポート到達不能エラー(タイプ3、コード 1、2、9、10、13)が返された場合、ポートはclosed（閉じている）状態
    - その他のICMPポート到達不能エラー(タイプ3、コード3)が返された場合、ポートはfiltered（フィルタあり）と見なされる。
      - まれにサービスがUDPパケットで応答することがあるが、その場合はポートがopenであることがわかる。
    - 数回の再試行の後も応答がない場合、ポートはopen|filteredに分類される。
      - これは、ポートが開いているか、もしくはパケットフィルタが通信を阻んでいることを意味する。
        - バージョンスキャン(-sV)を用いて、実際に開いているポートとフィルタ処理されたポートを識別することもできる。
  - 先ほどにも言った通り，UDPスキャンは低速なので他のオプションと組み合わせてスキャンを効率的に行うべきである。次のように，最もよく使用される UDP ポートの上位 20 個をスキャンするのがよい:
  ```nmap -sU --top-ports 20 <target>```

> *: ちなみに自分のPCで特定のポートをRSTで応答するようにファイアウォールを設定するには次のコマンドを使う:
>
> ```iptables -I INPUT -p tcp --dport <port> -j REJECT --reject-with tcp-reset```

## その他のオプション
TCPヘッダのフラグには，先のACK, SYN, RSTの他にも以下のようなものがある:
- URG(Urgent): 緊急に処理すべきデータが含まれているフラグ
- PSH(Push): 受信データをバッファリングせずに即座にアプリケーション層に渡せというフラグ
- FIN(Fin): コネクションの正常な終了を要求するフラグ 

これら6種のフラグを元にスキャンする命令は以下の通り:
- -sN: TCP Nullスキャン。どのフラグも設定していないパケットを送信することでスキャンを行う。</br>
TCP/IPではこのようなパケットを受信した場合、ポートの状態が「closed」であればRSTフラグ付きのパケットを返送する。いっぽうポートで待ち受けが行われていれば、何もパケットを返送しない。つまり、パケットの返送があればそのポートは「closed」であり、返送が無ければ「open」もしくは「filtered」のどちらか（「open|filtered」）であると判断できる。
- -sF: FINスキャン。TCPのFINフラグのみを設定したパケットを利用する。
-  -sX: Xmasスキャン。FINおよびPSH、URGフラグを設定したパケットを利用する。

これらスキャン方式を利用するメリットは、特定のファイアウォールやパケットフィルタをすり抜けることが可能であるという点だ。(有効性はターゲットのOSやファイアウォール/ルーターによって異なる)

## 範囲指定ネットワークスキャン
- ネットワークスキャンにおいて，最初に行うのはネットワーク構造を把握すること。
- -sn オプションをつけて"ping スイープ"を実行することでスキャンする。<br>

例:    ```nmap -sn 192.168.0.1-254```
- Nmap は、指定されたネットワークの IP アドレスに ICMP パケットを送信する。このパケットを受信すると、応答した IP アドレスが生きているとしてマークされる

## NSEスクリプト
- Nmap Script Engine というnmapの拡張機能がある。
- 次のようなカテゴリがある:
  - safe:ターゲットへの影響は暗視
  - intrusive: ターゲットに影響を与える可能性大
  - vuln: 脆弱性スキャン
  - exploit: 脆弱性の悪用
  - 全てのジャンルはここから: https://nmap.org/book/nse-usage.html

### 使い方
  - ```--script=<script-name>```
  - スクリプトによっては引数が違うので，このサイトで確認: https://nmap.org/nsedoc/

### スクリプトの検索
- /usr/share/nmap/scripts ここにスクリプトは格納されている。
- /usr/share/nmap/scripts/script.db　がデータベース。<br>次のように検索できる。例)ftpを含むもの:
  - grep "ftp" /usr/share/nmap/scripts/script.db
  - lsls -l /usr/share/nmap/scripts/\*ftp*

### スクリプトの追加
```
sudo apt update && sudo apt install nmap
sudo wget -O /usr/share/nmap/scripts/<script-name>.nse https://svn.nmap.org/nmap/scripts/<script-name>.nse
nmap --script-updatedbscript.db
```

## ファイアウォール回避
- 通常の Windows ホストは、デフォルトのファイアウォールを使用して、すべての ICMP パケットをブロックする。
- したがって、この構成を回避する方法が必要:
  - -pn: スキャンする前にホストに対してわざわざpingしないようにNmapに指示。
    - Nmap は常にターゲット ホストを生きているホストとして仮定し、ICMP ブロックを効果的にバイパス。
    - しかし、スキャンを完了するのに非常に長い時間がかかる

他にも回避に役立ちそうなオプション:
- -f: パケットをフラグメント化 (つまり、小さな断片に分割) するために使用されるため、パケットがファイアウォール検出される可能性が低くなる。
- --mtu \<number>:パケットのサイズをより詳細に制御できる。これは 8 の倍数である必要がある
- --scan-delay \<time>ms: 送信されたパケット間に遅延を追加・タイムアウト回避のために使用される。ネットワークが不安定な場合だけでなく、時間ベースのファイアウォールトリガーを回避する場合にも非常に便利
- --badsum: これは、無効なチェックサムのパケット送信に使用されます。実際の TCP/IP スタックは、このパケットをドロップするが、ファイアウォールはパケットのチェックサムをわざわざチェックすることなく、自動的に応答する可能性があり、このスイッチを使用して、ファイアウォールの存在を確認できる。