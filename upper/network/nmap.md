# NMap

ハンズオン: 
https://tryhackme.com/room/furthernmap

---

## ポートとは?
- ポートはよくドアに例えられる。
  - IPアドレスが住所 - 家であれば、ポートは外に出る・外から入るドアに該当します。

- 全てのコンピュータには合計65535個のポートがある。
- ただし一部は標準ポートとして予約されている。
  - HTTP: 80
  - HTTPS: 443
  - SSH: 22

> これらのポートは，ホストとしてサービスを実行している側(つまりサーバー)が開くものである。
>
> こちら(クライアント側)がアクセスする際には適当なポート番号(10000番台)が使われる。
>
> 例: サイトにアクセスする際，サイトのサーバーの80ポートと自分のPCの18753ポートが接続される。

- **NMap**は，特定のサーバーをスキャンし，どのポートがどのように使用されているかを調べるコマンドである。

## NMap の主要なスイッチ


---

- -vv: より詳細な情報を表示させる
- -O: ターゲットで実行されているOSを調べる
- -sV: ターゲットで実行されているサービスのバージョンを調べる

> -A(Aggressice) オプション1つで-O, -sVどちらも有効にできる!!

- -T1 ~ -T5: スキャンの速度を上げる。早いほど結果は雑になる
- -p: スキャンするポートを選択。
  - -p 80 で80ポート
  - -p 1000-1500 で1000-1500ポートをスキャン
  - -p- で全ポートをスキャン
 - -oN \<FILE NAME>: ファイルに出力結果を保存。
- --script \<script name>: 指定したスクリプトを使って，nmapを拡張できる。 


## スキャンの種類

- SYN "Half-open" Scans (-sS)
  - もっとも一般的かつ有用なオプション。
  - TCPの3way ハンドシェイクにおけるSYNパケットの送信のみを行い，応答の有(SYN/ACK返信)/無(RST返信)を見てポートを分類する。*
    - そのため秘匿性が高い
  - 欠点: SYNスキャンでは生パケットを作成する機能が必要であり，これにはSudo権限が必要。
- TCP Connect Scans (-sT)
  - -Ssが使えない時の代替手段。OSのシステムコール( connect() )を使い，3way ハンドシェイクにしたがって丁寧に(?)ポートをスキャンする。
  - 相違点:
    - ACKを最後に送って確認応答する
    - RSTが帰ってくるとNmapはポートが閉じられたことを確認
    - ファイアウォールにドロップされると，ポートがフィルタリングされていると確認
- UDP Scans (-sU)

> *: ちなみに自分のPCで特定のポートをRSTで応答するようにファイアウォールを設定するには次のコマンドを使う:
> ```iptables -I INPUT -p tcp --dport <port> -j REJECT --reject-with tcp-reset```
